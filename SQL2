WITH S AS(
SELECT *, LAG(CONTRACT_TYPE) OVER(ORDER BY ID,DATES,CONTRACT_TYPE) AS PREV FROM CHALLENGE 
),
A AS(
SELECT	*,SUM(CASE WHEN CONTRACT_TYPE = prev THEN 0 ELSE 1 END) OVER(ORDER BY ID,DATES,CONTRACT_TYPE) as ROW_N
FROM S
),
C AS (
SELECT id,
MIN(dates) OVER(PARTITION BY ROW_N) AS STRT_DATE,
CASE WHEN LEAD(ID) OVER(ORDER BY ID,DATES,CONTRACT_TYPE) = ID 
	 THEN
         CASE WHEN LEAD(CONTRACT_TYPE)OVER(ORDER BY ID,DATES,CONTRACT_TYPE) != CONTRACT_TYPE  
			 THEN LEAD(DATES) OVER(ORDER BY ID,DATES,CONTRACT_TYPE) 
			 ELSE NULL
			END
	  ELSE NULL
	 END AS END_DATE,
contract_type,ROW_N 
FROM  ) 
SELECT MAX(id) as ID ,MAX(strt_date) AS STRT_DATE,MAX(end_date) AS END_DATE, MAX(contract_type) AS CONTRACT_TYPE FROM c group by ROW_N;
