use demo ;

create table DEMO3 ( ISU int, MOVE_IN DATE,MOVE_OUT DATE, start_date date, end_date date ,contract_type varchar(60));

DROP TABLE demo3
Delete from demo3 where contract_type='camp'

insert into DEMO3 values
(1109,'2001-09-04','2002-01-06','2001-12-26','2002-01-06','YUT'),
(1109,'2001-09-04','2002-01-06','2001-09-04','2001-06-03','TRY'),
(1109,'2001-09-04','2002-01-06','2001-10-14','2001-11-03','HAL'),
(1109,'2001-09-04','2002-01-06','2001-11-04','2001-12-13','CON'),
(1109,'2001-09-04','2002-01-06','2001-12-24','2002-01-06','DOK'),
insert into DEMO3 values
(778,'2005-12-04','2012-01-06','2005-12-04','2012-01-06','CAMP'),
(2345,'2005-12-04','2012-01-06','2006-10-04','2006-12-06','DF'),
(2345,'2005-12-04','2012-01-06','2007-12-04','2012-01-06','BHI');

SELECT * FROM DEMO3 ORDER BY ISU,START_DATE;

WITH A AS (
SELECT *,
RANK() OVER (PARTITION BY ISU,START_DATE ORDER BY END_DATE DESC) AS SR,
RANK() OVER (PARTITION BY ISU,END_DATE ORDER BY START_DATE ASC) AS SR,
COUNT(ISU) OVER(PARTITION BY ISU) AS C FROM DEMO3 
WHERE MOVE_IN = START_DATE OR MOVE_OUT = END_DATE
),
b as (
SELECT ISU, MOVE_IN,MOVE_OUT, 
CASE WHEN C = 1 THEN CONTRACT_TYPE ELSE CONTRACT_TYPE END AS IN_CT,
CASE WHEN C = 1 THEN CONTRACT_TYPE ELSE LEAD(CONTRACT_TYPE) OVER (PARTITION BY ISU order BY END_DATE DESC) END AS OUT_CT
FROM A WHERE SR = 1 
)
SELECT * FROM B WHERE OUT_CT IS NOT NULL;


******************************************************************************************************************************************************
MAIN QUERY


WITH A AS (
SELECT *,
RANK() OVER (PARTITION BY ISU,START_DATE ORDER BY END_DATE DESC) AS SR,
COUNT(ISU) OVER(PARTITION BY ISU) AS C FROM DEMO3 
WHERE MOVE_IN = START_DATE OR MOVE_OUT = END_DATE
)
,
C AS 
(
SELECT *,
RANK() OVER (PARTITION BY ISU,END_DATE ORDER BY START_DATE ASC) AS ER,
COUNT(ISU) OVER(PARTITION BY ISU) AS C FROM DEMO3 
WHERE MOVE_IN = START_DATE OR MOVE_OUT = END_DATE
)
,
S AS (
SELECT * FROM A WHERE SR=1
)
,
R AS(
SELECT * FROM C WHERE ER=1
),
G AS (
SELECT S.ISU,S.MOVE_IN,S.MOVE_OUT,S.START_DATE,S.END_DATE,S.CONTRACT_TYPE,S.C FROM S  INNER JOIN R ON 
S.ISU = R.ISU AND S. MOVE_IN = R.MOVE_IN AND S. MOVE_OUT = R.MOVE_OUT 
AND S.START_DATE= R.START_DATE AND S.END_DATE = R.END_DATE
)
,
b as (
SELECT ISU, MOVE_IN,MOVE_OUT, 
CASE WHEN C = 1 THEN CONTRACT_TYPE ELSE CONTRACT_TYPE END AS IN_CT,
CASE WHEN C = 1 THEN CONTRACT_TYPE ELSE LEAD(CONTRACT_TYPE) OVER (PARTITION BY ISU order BY END_DATE DESC) END AS OUT_CT
FROM G
)
SELECT * FROM B WHERE OUT_CT IS NOT NULL;
